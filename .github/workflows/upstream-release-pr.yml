name: Sync upstream release

on:
  workflow_dispatch:

jobs:
  sync-upstream-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect new upstream tag
        id: detect
        run: |
          UPSTREAM_REPO="https://github.com/onyx-dot-app/onyx.git"

          UPSTREAM_TAGS=$(git ls-remote --tags "$UPSTREAM_REPO" \
            | awk '{print $2}' \
            | sed 's#refs/tags/##' \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V)

          LOCAL_TAGS=$(git tag \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V)

          NEW_TAG=$(comm -13 <(echo "$LOCAL_TAGS") <(echo "$UPSTREAM_TAGS") | head -n 1)

          if [ -z "$NEW_TAG" ]; then
            echo "No new upstream tag"
            exit 0
          fi

          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Fetch upstream tag
        if: steps.detect.outputs.tag != ''
        run: |
          git remote add upstream https://github.com/onyx-dot-app/onyx.git
          git fetch upstream refs/tags/${{ steps.detect.outputs.tag }}:refs/tags/${{ steps.detect.outputs.tag }}

      - name: Create branch from tag
        if: steps.detect.outputs.tag != ''
        run: |
          BRANCH="upstream/${{ steps.detect.outputs.tag }}"
          git checkout -B "$BRANCH" "refs/tags/${{ steps.detect.outputs.tag }}"
          git push origin "$BRANCH" --force

      - name: Open Pull Request
        if: steps.detect.outputs.tag != ''
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          head: upstream/${{ steps.detect.outputs.tag }}
          title: "chore: sync upstream release ${{ steps.detect.outputs.tag }}"
          body: |
            This PR syncs upstream release **${{ steps.detect.outputs.tag }}**.

            - Source: upstream tag
            - Pattern: vX.Y.Z
            - Generated automatically by CI
          labels: |
            upstream
            release
