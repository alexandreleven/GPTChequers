name: Sync upstream release

on:
  workflow_dispatch:

# Permissions needed to push branches and create PRs using PR_OPENER
permissions:
  contents: write
  pull-requests: write

jobs:
  sync-upstream-release:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # Step 1: Checkout the fork repository
      - name: Checkout fork
        timeout-minutes: 5
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to allow tags and branch creation
          token: ${{ secrets.PR_OPENER }}

      # Step 2: Detect new upstream tag greater than local max tag
      - name: Detect new upstream tag
        id: detect
        timeout-minutes: 5
        run: |
          UPSTREAM_REPO="https://github.com/onyx-dot-app/onyx.git"

          # Get all upstream tags matching vX.Y.Z pattern, sorted in ascending order
          UPSTREAM_TAGS=$(git ls-remote --tags "$UPSTREAM_REPO" \
            | awk '{print $2}' \
            | sed 's#refs/tags/##' \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V)

          # Get the highest local tag matching vX.Y.Z
          LOCAL_MAX_TAG=$(git tag \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V \
            | tail -n 1)

          echo "Local max tag: $LOCAL_MAX_TAG"

          # Filter upstream tags that are strictly greater than LOCAL_MAX_TAG
          NEW_TAG=$(echo "$UPSTREAM_TAGS" \
            | awk -v local="$LOCAL_MAX_TAG" 'BEGIN{split(local,a,".");} 
              {
                split($0,b,"."); 
                if (b[1]>a[1] || (b[1]==a[1] && b[2]>a[2]) || (b[1]==a[1] && b[2]==a[2] && b[3]>a[3])) 
                  print $0
              }' \
            | head -n 1)

          if [ -z "$NEW_TAG" ]; then
            echo "No new upstream tag greater than $LOCAL_MAX_TAG"
            exit 0
          fi

          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

      # Step 3: Fetch the specific upstream tag
      - name: Fetch upstream tag
        if: steps.detect.outputs.tag != ''
        timeout-minutes: 5
        run: |
          git remote add upstream https://github.com/onyx-dot-app/onyx.git
          git fetch upstream refs/tags/${{ steps.detect.outputs.tag }}:refs/tags/${{ steps.detect.outputs.tag }}

      # Step 4: Checkout upstream tag
      - name: Checkout upstream tag
        if: steps.detect.outputs.tag != ''
        timeout-minutes: 5
        run: |
          git checkout refs/tags/${{ steps.detect.outputs.tag }}

      - name: Create branch from tag
        if: steps.detect.outputs.tag != ''
        timeout-minutes: 5
        run: |
          git checkout -B upstream/${{ steps.detect.outputs.tag }}

      - name: Push upstream release branch
        if: steps.detect.outputs.tag != ''
        timeout-minutes: 5
        run: |
          git push -u origin upstream/${{ steps.detect.outputs.tag }}

      # Step 5: Open a Pull Request from the new branch to main
      - name: Open Pull Request
        if: steps.detect.outputs.tag != ''
        timeout-minutes: 5
        env:
          GH_TOKEN: ${{ secrets.PR_OPENER }}
        run: |
          BRANCH="upstream/${{ steps.detect.outputs.tag }}"
          TAG="${{ steps.detect.outputs.tag }}"
          
          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for branch $BRANCH"
          else
            # Check if workflow files are modified
            WORKFLOW_CHANGES=$(git diff --name-only main..."$BRANCH" -- '.github/workflows/' | wc -l)
            
            LABELS=""
            if [ "$WORKFLOW_CHANGES" -gt 0 ]; then
              LABELS="--label workflow-changes"
              echo "⚠️ Warning: $WORKFLOW_CHANGES workflow file(s) modified by upstream"
            fi
            
            PR_BODY=$(printf "This PR syncs upstream release **%s**.\n\n**Workflow changes:** %s file(s) in \`.github/workflows/\`" "$TAG" "$WORKFLOW_CHANGES")

            gh pr create \
              --base main \
              --head "$BRANCH" \
              --title "chore: sync upstream release $TAG" \
              --body "$PR_BODY" \
              $LABELS
          fi

      # Step 6: Create tag in fork
      - name: Create tag in fork
        if: steps.detect.outputs.tag != ''
        timeout-minutes: 5
        run: |
          TAG=${{ steps.detect.outputs.tag }}
      
          # Tag already exists? Do nothing.
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists"
            exit 0
          fi
      
          # Create tag pointing to the already-fetched upstream tag commit
          git tag "$TAG" "refs/tags/$TAG"
          git push origin "$TAG"

